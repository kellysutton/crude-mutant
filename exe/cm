#!/usr/bin/env ruby
# frozen_string_literal: true

require "crude-mutant"

test_command = ARGV[0]
file_to_mutate = ARGV[1]

if !file_to_mutate || !test_command
  puts "Usage: crude-mutant [test command] [file to mutate]"
  puts ""
  puts "Example:"
  puts "  crude-mutant \"bundle exec rspec\" app/models/post.rb"
  exit(1)
end

CrudeMutant.start(file_to_mutate, test_command) do |progress|
  clear_string = ' ' * CrudeMutant::TerminalCalculator.new.calculate_length
  $stdout.print clear_string
  $stdout.print "\r"

  completed = "Completed #{progress.run_results.size}/#{progress.total_runs_to_perform}"
  average = "Average time per run: #{progress.avg_time.round(2)} second(s)"
  eta_time = (progress.total_runs_to_perform - progress.run_results.size) * progress.avg_time
  eta = "Estimated time of completion: #{eta_time.round(2)} seconds"
  $stdout.print "#{completed} #{average} #{eta}\r"
  $stdout.flush
end
