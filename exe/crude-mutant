#!/usr/bin/env ruby
# frozen_string_literal: true

require "crude-mutant"
require "optparse"

test_command = ARGV[0]
file_to_mutate = ARGV[1]

Options = Struct.new(:use_json_printer)

args = Options.new(false)
OptionParser.new do |opts|
  opts.banner = "Usage: crude-mutant [options] [test command] [file to mutate]"

  opts.on("-j", "--json", "Print JSON out to STDOUT") do |v|
    args.use_json_printer = v
  end
end.parse!

if !file_to_mutate || !test_command
  puts "Usage: crude-mutant [test command] [file to mutate]"
  puts ""
  puts "Example:"
  puts "  crude-mutant \"bundle exec rspec\" app/models/post.rb"
  exit(1)
end

printer = args.use_json_printer ? :json : :standard

if printer == :json
  CrudeMutant.start(file_to_mutate, test_command, result_printer: printer)
else
  CrudeMutant.start(file_to_mutate, test_command, result_printer: printer) do |progress|
    clear_string = ' ' * CrudeMutant::TerminalCalculator.new.calculate_length
    $stdout.print clear_string
    $stdout.print "\r"

    completed = "Completed #{progress.run_results.size}/#{progress.total_runs_to_perform}"
    average = "Average time per run: #{progress.avg_time.round(2)} second(s)"
    eta_time = (progress.total_runs_to_perform - progress.run_results.size) * progress.avg_time
    eta = "Estimated time of completion: #{eta_time.round(2)} seconds"
    $stdout.print "#{completed} #{average} #{eta}\r"
    $stdout.flush
  end
end
